name: AWS Inspector SBOM & Security Scan

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'course-site-with-nodejs-backend/server-nodejs/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'course-site-with-nodejs-backend/server-nodejs/**'
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday at 6 AM

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: int/server-nodejs
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/server-nodejs

jobs:
  aws-inspector-scan:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::950555670656:role/github-oidc
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: Build and push to ECR
      id: build-ecr
      uses: docker/build-push-action@v5
      with:
        context: ./course-site-with-nodejs-backend/server-nodejs
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        
    - name: Wait for image to be available
      run: |
        echo "â³ Waiting for image to be available in ECR..."
        sleep 30
        
    - name: Run AWS Inspector scan
      id: inspector-scan
      run: |
        echo "ðŸ” Starting AWS Inspector container scan..."
        IMAGE_URI="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest"
        
        # Start Inspector scan
        SCAN_ID=$(aws inspector2 batch-get-free-trial-info --account-ids ${{ secrets.AWS_ACCOUNT_ID }} --query 'accounts[0].accountId' --output text 2>/dev/null || echo "")
        
        # Use Inspector V2 API to scan the image
        aws inspector2 batch-get-finding-details \
          --finding-arns $(aws inspector2 list-findings \
            --filter-criteria '{"ecrImageTags":[{"comparison":"EQUALS","value":"latest"}]}' \
            --query 'findings[].findingArn' --output text) \
          --output json > inspector-findings.json || echo "[]" > inspector-findings.json
          
        echo "âœ… AWS Inspector scan completed"
        
    - name: Generate SBOM using AWS Inspector SBOM Generator
      run: |
        echo "ðŸ“‹ Generating SBOM using AWS Inspector SBOM Generator..."
        IMAGE_URI="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest"
        
        # Download and install AWS Inspector SBOM Generator
        wget https://amazon-inspector-sbomgen.s3.amazonaws.com/latest/linux/amd64/inspector-sbomgen.zip
        unzip inspector-sbomgen.zip
        
        # Find the correct path to the binary
        INSPECTOR_BINARY=$(find . -name "inspector-sbomgen" -type f)
        chmod +x "$INSPECTOR_BINARY"
        
        # Generate SBOM for container image and scan with Inspector
        "$INSPECTOR_BINARY" container --image $IMAGE_URI \
          --scan-sbom \
          --aws-region ${{ env.AWS_REGION }} \
          --scan-sbom-output-format cyclonedx \
          --outfile inspector-cyclonedx-sbom.json
        
        # Generate SBOM without scanning for backup
        "$INSPECTOR_BINARY" container --image $IMAGE_URI \
          --outfile inspector-sbom-only.json
        
        # Generate SBOM from source directory
        "$INSPECTOR_BINARY" directory --path ./course-site-with-nodejs-backend/server-nodejs \
          --outfile source-inspector-sbom.json
        
        echo "âœ… SBOM generated using AWS Inspector SBOM Generator"
        
    - name: Generate Node.js dependency SBOM
      run: |
        echo "ðŸ“‹ Generating Node.js dependency SBOM..."
        
        # Install CycloneDX Node.js tool
        npm install -g @cyclonedx/cyclonedx-npm
        
        # Generate SBOM from package.json
        cd course-site-with-nodejs-backend/server-nodejs
        cyclonedx-npm --output-file ../../nodejs-dependencies-sbom.json
        cd ../..
        
        echo "âœ… Node.js dependency SBOM generated"
        
    - name: Use Inspector SBOM with integrated vulnerability data
      run: |
        echo "ðŸ“‹ Using AWS Inspector SBOM with integrated vulnerability data..."
        
        # Install jq for JSON processing
        sudo apt-get update && sudo apt-get install -y jq
        
        # The inspector-cyclonedx-sbom.json already contains vulnerability data from Inspector
        # Use it as the primary enhanced SBOM
        if [ -f inspector-cyclonedx-sbom.json ]; then
          cp inspector-cyclonedx-sbom.json enhanced-aws-sbom.json
          echo "âœ… Using Inspector SBOM with integrated vulnerability scanning"
        else
          # Fallback to Inspector SBOM without scanning
          if [ -f inspector-sbom-only.json ]; then
            cp inspector-sbom-only.json enhanced-aws-sbom.json
            echo "âš ï¸ Using Inspector SBOM without vulnerability scanning"
          else
            # Final fallback to Node.js dependencies SBOM
            cp nodejs-dependencies-sbom.json enhanced-aws-sbom.json
            echo "âš ï¸ Using Node.js dependencies SBOM as fallback"
          fi
        fi
        
        echo "âœ… Enhanced SBOM ready with AWS Inspector integration"
        
    - name: Upload SBOM to S3
      run: |
        echo "â˜ï¸ Uploading SBOM to S3..."
        BUCKET_NAME="sbom-int-inspector-data"
        
        if [ ! -z "$BUCKET_NAME" ]; then
          # Upload all Inspector SBOM files to S3
          aws s3 cp inspector-cyclonedx-sbom.json "s3://$BUCKET_NAME/sbom/${{ github.repository }}/${{ github.sha }}/inspector-cyclonedx-sbom.json" || true
          aws s3 cp inspector-sbom-only.json "s3://$BUCKET_NAME/sbom/${{ github.repository }}/${{ github.sha }}/inspector-sbom-only.json" || true
          aws s3 cp source-inspector-sbom.json "s3://$BUCKET_NAME/sbom/${{ github.repository }}/${{ github.sha }}/source-inspector-sbom.json" || true
          aws s3 cp nodejs-dependencies-sbom.json "s3://$BUCKET_NAME/sbom/${{ github.repository }}/${{ github.sha }}/nodejs-dependencies-sbom.json" || true
          aws s3 cp enhanced-aws-sbom.json "s3://$BUCKET_NAME/sbom/${{ github.repository }}/${{ github.sha }}/enhanced-aws-sbom.json"
          
          echo "âœ… SBOM files uploaded to S3"
        else
          echo "â„¹ï¸ S3 bucket not configured, skipping upload"
        fi
        
    - name: Attest AWS Inspector SBOM
      uses: actions/attest-sbom@v1
      with:
        subject-path: ./enhanced-aws-sbom.json
        sbom-path: ./enhanced-aws-sbom.json
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: aws-inspector-sbom-${{ github.sha }}
        path: |
          ./inspector-cyclonedx-sbom.json
          ./inspector-sbom-only.json
          ./source-inspector-sbom.json
          ./nodejs-dependencies-sbom.json
          ./enhanced-aws-sbom.json
          ./inspector-findings.json
        retention-days: 90
        
    - name: Generate security report
      run: |
        echo "ðŸ“Š Generating security report..."
        
        cat > security-report.md << 'EOF'
        # AWS Inspector Security Report
        
        **Repository:** ${{ github.repository }}
        **Commit:** ${{ github.sha }}
        **Scan Date:** $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)
        **Image:** ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
        
        ## Scan Summary
        
        - âœ… AWS Inspector scan completed
        - ðŸ“‹ SBOM generated in multiple formats
        - ðŸ” Vulnerability assessment performed
        - â˜ï¸ Results uploaded to AWS S3
        - ðŸ” SBOM attestation created
        
        ## Files Generated
        
        1. `aws-inspector-sbom.json` - Basic SPDX format SBOM
        2. `enhanced-aws-sbom.json` - CycloneDX format with vulnerabilities
        3. `inspector-findings.json` - Raw Inspector findings
        4. `ecr-image-details.json` - ECR image metadata
        
        ## Next Steps
        
        - Review findings in AWS Inspector console
        - Check S3 bucket for uploaded SBOM files
        - Verify attestations in GitHub
        
        EOF
        
        echo "âœ… Security report generated"
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });

  cleanup-old-images:
    needs: [aws-inspector-scan]
    runs-on: ubuntu-latest
    if: always()
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::950555670656:role/github-oidc
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Cleanup old ECR images
      run: |
        echo "ðŸ§¹ Cleaning up old ECR images..."
        
        # Keep only the last 10 images
        aws ecr list-images \
          --repository-name ${{ env.ECR_REPOSITORY }} \
          --filter tagStatus=UNTAGGED \
          --query 'imageIds[?imageDigest!=null]' \
          --output json | \
        jq '.[:10]' | \
        aws ecr batch-delete-image \
          --repository-name ${{ env.ECR_REPOSITORY }} \
          --image-ids file:///dev/stdin || echo "No images to cleanup"
          
        echo "âœ… ECR cleanup completed"
